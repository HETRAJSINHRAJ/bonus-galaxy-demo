// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Receipt {
  id            String   @id @default(cuid())
  userId        String   // Clerk User ID
  qrCodeData    String
  receiptDate   DateTime
  amount        Float
  taxId         String?  // ATU Number
  pointsEarned  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([receiptDate])
}

model PointsTransaction {
  id          String   @id @default(cuid())
  userId      String   // Clerk User ID
  amount      Int
  type        String   // "earn", "spend", "win"
  description String?
  receiptId   String?
  createdAt   DateTime @default(now())

  @@index([userId])
}

model Voucher {
  id              String   @id @default(cuid())
  name            String
  description     String
  partnerName     String
  partnerLogoUrl  String?
  price           Float
  pointsCost      Int      @default(0)
  discountPercent Int      @default(0)
  paymentMethod   String   @default("cash") // "cash" or "points" - determines which payment option is available
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model VoucherPurchase {
  id              String   @id @default(cuid())
  userId          String   // Clerk User ID
  voucherId       String
  stripeSessionId String?
  status          String   // "pending", "completed", "failed", "redeemed", "expired"
  amount          Float
  
  // Redemption fields
  pinCode         String?  @unique // 4-digit PIN for validation
  qrCodeData      String?  @unique // Encrypted QR code payload
  isRedeemed      Boolean  @default(false)
  redeemedAt      DateTime?
  redeemedBy      String?  // Employee ID or name
  redeemedLocation String? // Partner location name
  expiresAt       DateTime? // Voucher expiration date
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([stripeSessionId])
  @@index([pinCode])
  @@index([qrCodeData])
  @@index([isRedeemed])
  @@index([expiresAt])
}

model Mission {
  id                String    @id @default(cuid())
  title             String
  description       String    @db.Text
  shortDescription  String?
  type              String    // "daily", "weekly", "monthly", "one-time", "recurring"
  category          String    // "shopping", "social", "engagement", "partner", "special"
  difficulty        String    @default("medium") // "easy", "medium", "hard"
  pointsReward      Int
  bonusReward       Int       @default(0)
  
  // Requirements & validation
  requirements      Json      // Flexible JSON for different requirement types
  validationRules   Json?     // Custom validation rules
  
  // Scheduling
  startDate         DateTime?
  endDate           DateTime?
  isActive          Boolean   @default(false)
  isScheduled       Boolean   @default(false)
  
  // Display & ordering
  imageUrl          String?
  iconName          String?
  displayOrder      Int       @default(0)
  isFeatured        Boolean   @default(false)
  isHidden          Boolean   @default(false)
  
  // Limits
  maxCompletions    Int?      // Max completions per user (null = unlimited)
  totalLimit        Int?      // Total completions across all users (null = unlimited)
  currentCompletions Int      @default(0)
  
  // Metadata
  tags              String[]
  targetAudience    String?   // "all", "new_users", "premium", etc.
  partnerName       String?
  partnerLogoUrl    String?
  
  // Admin
  createdBy         String    // Clerk User ID of creator
  lastEditedBy      String?   // Clerk User ID of last editor
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  userProgress      UserMissionProgress[]
  analytics         MissionAnalytics[]

  @@index([isActive, startDate, endDate])
  @@index([type, category])
  @@index([isFeatured, displayOrder])
  @@index([createdBy])
}

model UserMissionProgress {
  id              String    @id @default(cuid())
  userId          String    // Clerk User ID
  missionId       String
  
  // Progress tracking
  status          String    @default("not_started") // "not_started", "in_progress", "completed", "expired", "failed"
  progress        Json      // Flexible progress tracking
  currentStep     Int       @default(0)
  totalSteps      Int       @default(1)
  
  // Completion
  completedAt     DateTime?
  completionCount Int       @default(0)
  rewardClaimed   Boolean   @default(false)
  rewardClaimedAt DateTime?
  
  // Metadata
  startedAt       DateTime  @default(now())
  lastActivityAt  DateTime  @default(now())
  expiresAt       DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  mission         Mission   @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@unique([userId, missionId])
  @@index([userId, status])
  @@index([missionId, status])
  @@index([completedAt])
}

model MissionAnalytics {
  id              String    @id @default(cuid())
  missionId       String
  date            DateTime  @default(now())
  
  // Engagement metrics
  views           Int       @default(0)
  starts          Int       @default(0)
  completions     Int       @default(0)
  failures        Int       @default(0)
  
  // User metrics
  uniqueUsers     Int       @default(0)
  newUsers        Int       @default(0)
  returningUsers  Int       @default(0)
  
  // Performance metrics
  avgCompletionTime Float?  // in minutes
  completionRate    Float?  // percentage
  dropoffRate       Float?  // percentage
  
  // Rewards distributed
  totalPointsAwarded Int    @default(0)
  totalBonusAwarded  Int    @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  mission         Mission   @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@unique([missionId, date])
  @@index([missionId])
  @@index([date])
}

// ============================================
// SHOP VOUCHER MANAGEMENT SYSTEM
// ============================================

model Shop {
  id              String   @id @default(cuid())
  name            String
  description     String?  @db.Text
  address         String?
  latitude        Float?
  longitude       Float?
  logo            String?  // URL to logo image
  
  // Contact Info
  email           String?
  phone           String?
  website         String?
  
  // Wallet & Points
  nequadaBalance  Int      @default(0) // Shop's accumulated points
  
  // Stats
  totalVouchersSold     Int @default(0)
  totalVouchersRedeemed Int @default(0)
  
  // Relationships
  employees       Employee[]
  voucherOffers   VoucherOffer[]
  
  // Metadata
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive])
  @@index([name])
}

model Employee {
  id              String   @id @default(cuid())
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  // User Info
  userId          String   // Links to Clerk user
  name            String
  email           String
  phone           String?
  
  // Security
  redemptionPinHash String // Hashed 4-6 digit PIN for redemption
  
  // Permissions
  canCreateVoucher  Boolean @default(false)
  canRedeemVoucher  Boolean @default(true)
  canViewAnalytics  Boolean @default(false)
  isManager         Boolean @default(false)
  
  // Stats
  totalRedemptions  Int     @default(0)
  totalOffersCreated Int    @default(0)
  
  // Relationships
  createdOffers     VoucherOffer[]  @relation("CreatedBy")
  redemptions       UserVoucher[]   @relation("RedeemedBy")
  
  // Metadata
  isActive        Boolean  @default(true)
  lastActiveAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([shopId, userId])
  @@index([shopId])
  @@index([userId])
  @@index([email])
}

model VoucherOffer {
  id              String   @id @default(cuid())
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  createdByEmpId  String
  createdBy       Employee @relation("CreatedBy", fields: [createdByEmpId], references: [id])
  
  // Offer Details
  title           String
  description     String   @db.Text
  termsOfService  String?  @db.Text
  imageUrl        String?
  
  // Pricing
  priceInPoints   Int      // Cost in Nequada points
  originalPrice   Float?   // Original cash price (for display)
  discountPercent Int?     // Discount percentage (for display)
  
  // Limits
  quota           Int?     // Optional: Max number of sales
  soldCount       Int      @default(0)
  redeemedCount   Int      @default(0)
  
  // Validity
  validFrom       DateTime @default(now())
  validUntil      DateTime?
  
  // Display
  category        String?  // "food", "drink", "service", etc.
  tags            String[]
  isFeatured      Boolean  @default(false)
  displayOrder    Int      @default(0)
  
  // Relationships
  userVouchers    UserVoucher[]
  
  // Metadata
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([shopId])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@index([category])
  @@index([isFeatured, displayOrder])
}

model UserVoucher {
  id              String   @id @default(cuid())
  
  // Ownership
  userId          String   // Clerk User ID
  offerId         String
  offer           VoucherOffer @relation(fields: [offerId], references: [id])
  
  // Status
  status          String   @default("purchased") // purchased, redeemed, expired, cancelled
  
  // Purchase Info
  purchasedAt     DateTime @default(now())
  pricePaid       Int      // Points paid at purchase
  
  // Redemption Info
  redeemedByEmpId String?
  redeemedBy      Employee? @relation("RedeemedBy", fields: [redeemedByEmpId], references: [id])
  redeemedAt      DateTime?
  redemptionNotes String?  // Optional notes from employee
  
  // QR/PIN Codes
  pinCode         String   @unique // 4-digit PIN
  qrCodeData      String?  @unique // Encrypted QR data
  
  // Metadata
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([offerId])
  @@index([status])
  @@index([pinCode])
  @@index([redeemedByEmpId])
  @@index([purchasedAt])
  @@index([redeemedAt])
}

model ShopAnalytics {
  id              String   @id @default(cuid())
  shopId          String
  date            DateTime @default(now())
  
  // Sales metrics
  vouchersSold    Int      @default(0)
  vouchersRedeemed Int     @default(0)
  revenue         Int      @default(0) // Points earned
  
  // Performance
  redemptionRate  Float?   // Percentage
  avgRedemptionTime Float? // Hours from purchase to redemption
  
  // Top performers
  topOfferId      String?
  topEmployeeId   String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([shopId, date])
  @@index([shopId])
  @@index([date])
}

model RedemptionLog {
  id              String   @id @default(cuid())
  
  // What
  voucherId       String
  offerId         String
  
  // Who
  userId          String   // Customer
  employeeId      String   // Employee who redeemed
  shopId          String
  
  // When & Where
  redeemedAt      DateTime @default(now())
  
  // How
  method          String   // "pin" or "qr"
  pinAttempts     Int      @default(1)
  
  // Result
  success         Boolean
  failureReason   String?
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  @@index([shopId, redeemedAt])
  @@index([employeeId])
  @@index([userId])
  @@index([success])
}

model EmployeePinAttempt {
  id              String   @id @default(cuid())
  employeeId      String
  
  // Attempt details
  success         Boolean
  attemptedAt     DateTime @default(now())
  ipAddress       String?
  
  // Security
  isLocked        Boolean  @default(false)
  lockUntil       DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([employeeId, attemptedAt])
  @@index([isLocked])
}
